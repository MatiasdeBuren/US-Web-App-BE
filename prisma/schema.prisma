generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  email     String    @unique
  password  String
  role      String?   @default("tenant") // "owner" | "tenant" | "admin"

  apartmentId Int?
  apartment   Apartment? @relation("TenantApartments", fields: [apartmentId], references: [id])
  ownedApartments Apartment[] @relation("OwnedApartments")

  reservations Reservation[] @relation("UserReservations")
  claims       Claim[]       @relation("UserClaims")
  claimAdhesions ClaimAdhesion[] @relation("UserClaimAdhesions")
  resetPasswordToken    String?       @unique
  resetPasswordExpires  DateTime?
  createdAt             DateTime      @default(now())
}

model Amenity {
  id           Int           @id @default(autoincrement())
  name         String
  capacity     Int
  maxDuration  Int           // in minutes
  openTime     String?       // "08:00" formato HH:mm - opcional por ahora
  closeTime    String?       // "19:00" formato HH:mm - opcional por ahora
  isActive     Boolean       @default(true)
  reservations Reservation[]
}

model Reservation {
  id        Int       @id @default(autoincrement())
  user      User      @relation("UserReservations", fields: [userId], references: [id])
  userId    Int
  amenity   Amenity   @relation(fields: [amenityId], references: [id])
  amenityId Int
  startTime DateTime
  endTime   DateTime
  status    String    @default("pendiente") // "pendiente", "confirmada", "cancelada"
  hiddenFromUser Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([amenityId, startTime, endTime]) 
}

model Apartment {
  id           Int      @id @default(autoincrement())
  unit         String
  floor        Int
  areaM2       Float?
  observations String?
  rooms       Int

  ownerId Int
  owner   User     @relation("OwnedApartments", fields: [ownerId], references: [id])

  tenants User[]   @relation("TenantApartments")
}

model Claim {
  id          Int      @id @default(autoincrement())
  subject     String
  category    String   // "ascensor" | "plomeria" | "electricidad" | "temperatura" | "areas_comunes" | "edificio" | "otro"
  description String
  location    String
  priority    String   // "baja" | "media" | "alta" | "urgente"
  status      String   @default("pendiente") // "pendiente" | "en_progreso" | "resuelto" | "rechazado"
  adminNotes  String?
  
  userId      Int
  user        User     @relation("UserClaims", fields: [userId], references: [id])
  adhesions   ClaimAdhesion[] @relation("ClaimAdhesions")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model ClaimAdhesion {
  id           Int      @id @default(autoincrement())
  claimId      Int
  userId       Int
  adhesionType String   // "support" | "disagree"
  
  claim        Claim    @relation("ClaimAdhesions", fields: [claimId], references: [id], onDelete: Cascade)
  user         User     @relation("UserClaimAdhesions", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([claimId, userId], name: "unique_user_claim_adhesion")
  @@index([claimId])
  @@index([userId])
}
