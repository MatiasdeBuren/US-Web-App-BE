generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  email     String    @unique
  password  String
  role      String?   @default("tenant") // "owner" | "tenant" | "admin"

  apartmentId Int?
  apartment   Apartment? @relation("TenantApartments", fields: [apartmentId], references: [id])
  ownedApartments Apartment[] @relation("OwnedApartments")

  reservations Reservation[] @relation("UserReservations")
  claims       Claim[]       @relation("UserClaims")
  claimAdhesions ClaimAdhesion[] @relation("UserClaimAdhesions")
  adminNotifications AdminNotification[] @relation("AdminNotifications")
  resetPasswordToken    String?       @unique
  resetPasswordExpires  DateTime?
  createdAt             DateTime      @default(now())
}

model Amenity {
  id           Int           @id @default(autoincrement())
  name         String
  capacity     Int
  maxDuration  Int           // in minutes
  openTime     String?       // "08:00" formato HH:mm - opcional por ahora
  closeTime    String?       // "19:00" formato HH:mm - opcional por ahora
  isActive     Boolean       @default(true)
  reservations Reservation[]
}

model ReservationStatus {
  id     Int    @id @default(autoincrement())
  name   String @unique // "pendiente", "confirmada", "cancelada", "finalizada"
  label  String // Spanish labels for display
  
  reservations Reservation[]
  
  @@map("reservation_statuses")
}

model Reservation {
  id        Int       @id @default(autoincrement())
  user      User      @relation("UserReservations", fields: [userId], references: [id])
  userId    Int
  amenity   Amenity   @relation(fields: [amenityId], references: [id])
  amenityId Int
  startTime DateTime
  endTime   DateTime
  statusId  Int       @default(1) // Default to "pendiente" (assuming it has id 1)
  status    ReservationStatus @relation(fields: [statusId], references: [id])
  hiddenFromUser Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([amenityId, startTime, endTime])
  @@index([statusId])
}

model Apartment {
  id           Int      @id @default(autoincrement())
  unit         String
  floor        Int
  areaM2       Float?
  observations String?
  rooms       Int

  ownerId Int
  owner   User     @relation("OwnedApartments", fields: [ownerId], references: [id])

  tenants User[]   @relation("TenantApartments")
}

model ClaimCategory {
  id     Int    @id @default(autoincrement())
  name   String @unique // "ascensor", "plomeria", "electricidad", "temperatura", "areas_comunes", "edificio", "otro"
  label  String // Spanish labels for display
  icon   String? // Icon identifier for frontend
  color  String? // Color for UI display
  
  claims Claim[]
  
  @@map("claim_categories")
}

model ClaimPriority {
  id     Int    @id @default(autoincrement())
  name   String @unique // "baja", "media", "alta", "urgente"
  label  String // Spanish labels for display
  level  Int    // Numeric priority level (1=lowest, 4=highest)
  color  String? // Color for UI display
  
  claims Claim[]
  
  @@map("claim_priorities")
}

model ClaimStatus {
  id     Int    @id @default(autoincrement())
  name   String @unique // "pendiente", "en_progreso", "resuelto", "rechazado"
  label  String // Spanish labels for display
  color  String? // Color for UI display
  
  claims Claim[]
  
  @@map("claim_statuses")
}

model Claim {
  id          Int      @id @default(autoincrement())
  subject     String
  categoryId  Int      @default(7) // Default to "otro" (assuming it has id 7)
  category    ClaimCategory @relation(fields: [categoryId], references: [id])
  description String
  location    String
  priorityId  Int      @default(2) // Default to "media" (assuming it has id 2)
  priority    ClaimPriority @relation(fields: [priorityId], references: [id])
  statusId    Int      @default(1) // Default to "pendiente" (assuming it has id 1)
  status      ClaimStatus @relation(fields: [statusId], references: [id])
  adminNotes  String?
  isAnonymous Boolean  @default(false) // Tracks if claim was created as anonymous
  
  userId      Int
  user        User     @relation("UserClaims", fields: [userId], references: [id])
  adhesions   ClaimAdhesion[] @relation("ClaimAdhesions")
  notifications AdminNotification[] @relation("ClaimNotifications")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([statusId])
  @@index([categoryId])
  @@index([priorityId])
}

model ClaimAdhesion {
  id           Int      @id @default(autoincrement())
  claimId      Int
  userId       Int
  adhesionType String   // "support" | "disagree"
  
  claim        Claim    @relation("ClaimAdhesions", fields: [claimId], references: [id], onDelete: Cascade)
  user         User     @relation("UserClaimAdhesions", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([claimId, userId], name: "unique_user_claim_adhesion")
  @@index([claimId])
  @@index([userId])
}

model AdminNotification {
  id               Int      @id @default(autoincrement())
  adminId          Int      // Foreign key to User (admin)
  claimId          Int      // Foreign key to Claim
  notificationType String   // "new_claim" | "urgent_claim"
  isRead           Boolean  @default(false)
  createdAt        DateTime @default(now())
  readAt           DateTime?
  
  admin            User     @relation("AdminNotifications", fields: [adminId], references: [id], onDelete: Cascade)
  claim            Claim    @relation("ClaimNotifications", fields: [claimId], references: [id], onDelete: Cascade)
  
  @@index([adminId])
  @@index([claimId])
  @@index([isRead])
  @@index([adminId, isRead]) // Composite index for filtering unread notifications by admin
  @@map("admin_notifications")
}
